import json

from src.conf import API_KEY
from src.feature.gpt import GptAPI
from src.feature.request.RequestHandler import RequestDataBase
from src.logger import logger
from src.service import redis


def change_post(post: str, links: list):
    prompt = f"""            
        ‚Ä¢ –†–æ–ª—å: –¢—ã –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª–∞, —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –≤—Å–µ –∑–Ω–∞–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –Ω–æ–≤–æ—Å—Ç–µ–π. 
        ‚Ä¢ –î–µ–π—Å—Ç–≤–∏–µ: 
        1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª—É—á–µ–Ω–Ω—É—é –Ω–æ–≤–æ—Å—Ç—å.
        2. –£–ª—É—á—à–∏ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—è –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –≤–µ—Ä—Å—Ç–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞. –¢–µ–≥–∏ –¥–ª—è –≤–µ—Ä—Å—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∫–∞–∑–∞–Ω—ã –Ω–∏–∂–µ, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏—Ö.
        –ü—Ä–∞–≤–∏–ª–∞ –≤–µ—Ä—Å—Ç–∫–∏ —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏—Ö –∏ –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö: 
            <b>bold</b>, <strong>bold</strong>
            <a href="http://www.example.com/">inline URL</a>
            <a href="tg://user?id=123456789">inline mention of a user</a>
            <code>inline fixed-width code</code>
            <pre>pre-formatted fixed-width code block</pre>
            <pre><code class="language-python">pre-formatted fixed-width code block written in the Python programming language</code></pre>
            <blockquote>Block quotation started\nBlock quotation continued\nThe last line of the block quotation</blockquote>
            <blockquote expandable>Expandable block quotation started\nExpandable block quotation continued\nExpandable block quotation continued\nHidden by default part of the block quotation started\nExpandable block quotation continued\nThe last line of the block quotation</blockquote>
        3. –î–æ–±–∞–≤—å –∫ –Ω–æ–≤–æ–≤—Å—Ç–∏ —Å—Å—ã–ª–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ - {links}. –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤–≤–µ–¥–µ—Ç –Ω–∞ —á—É–∂–æ–π —Ç–µ–ª–µ–≥—Ä–∞–º–º 
        –∫–∞–Ω–∞–ª(–ù–∞—à —Ç–µ–ª–µ–≥—Ä–∞–º–º –∫–∞–Ω–∞–ª - https://t.me/headlinerussian), —Ç–æ –µ–µ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –≤–æ—Ç –∫–∞–∫ —Ç–∞–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤—ã–≥–ª—è–¥—è—Ç - https://t.me/.   
        4. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –Ω–æ–≤–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å —Å–Ω–∏–∑—É —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–∞—à —Ç–µ–ª–µ–≥—Ä–∞–º–º –∫–∞–Ω–∞–ª –∏ —Å–¥–µ–ª–∞–π –¥–≤–∞ –æ—Ç—Å—Ç—É–ø –æ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏:
            <a href="https://t.me/headlinerussian">üó£Ô∏è Headline | –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>.
        5. –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏ —Ç—ã —Ç–µ–≥–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥–ª—è –≤–µ—Ä—Å—Ç–∫–∏ –∏ —Ç–∞–∫ –∂–µ –ø—Ä–æ–≤–µ—Ä—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —á—É–∂–∏–µ —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª—ã. 
        
        ‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç: —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –Ω–æ–≤–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç aiogram, —è –æ—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ–±–µ –Ω–æ–≤–æ—Å—Ç—å, –∞ —Ç—ã –¥–µ–ª–∞–µ—à—å –µ–µ –≤–∏–∑—É–∞–ª—å–Ω–æ –ª—É—á—à–µ. 
        –ß—Ç–æ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å:
        1.	–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è:
        - –ò–∑–±–µ–≥–∞—Ç—å —Ä–µ–∑–∫–∏—Ö –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–π –ø–æ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É, –ø–æ–ª–æ–≤–æ–º—É –∏–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–º—É –ø—Ä–∏–∑–Ω–∞–∫—É.
        3.	–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ—Å—Å–∏—è:
        - –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –æ—Å–≤–µ—â–µ–Ω–∏–∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ–º.
        4.	–°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã:
        - –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∂–∞—Ä–≥–æ–Ω, –µ—Å–ª–∏ –æ–Ω –Ω–µ –∫–ª—é—á–µ–≤–æ–π –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è.
        5.	–ß—Ä–µ–∑–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–∞:
        - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏.
        6. –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–º–∞–π–ª–∏–∫–∏
        - –°–º–∞–π–ª–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å, –Ω–æ —Ç–æ–ª—å–∫–æ –Ω–µ –±–æ–ª—å—à–µ 1 –∑–∞ –ø–æ—Å—Ç
        7. –°—Å—ã–ª–∫–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ç–µ–ª–µ–≥—Ä–∞–º–º –∫–∞–Ω–∞–ª—ã
        - –≤—Å–µ —Å—Å—ã–ª–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∫—Ä–æ–º–µ —Ç–µ—Ö –∫–æ—Ç–æ—Ä—ã–µ –≤–≤–µ–¥—É—Ç –Ω–∞ –¥—Ä—É–≥–æ–π —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª, –æ–Ω–∏ –ø–æ—Ö–æ–∂–µ –Ω–∞ 'https://t.me/' –∏–ª–∏ '@whackdoor'

        –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:
        1.	–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:
        –ú–æ–ª–æ–¥–µ–∂—å –∏ –≤–∑—Ä–æ—Å–ª—ã–µ —Å –∞–∫—Ç–∏–≤–Ω–æ–π –∂–∏–∑–Ω–µ–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–µ–π –æ—Ç 18 –¥–æ 40.
        2.	–°—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è:
        - –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π.
        - –ö—Ä–∞—Ç–∫–∏–µ, —Ü–µ–ø–ª—è—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–µ—Ä–≤—ã–µ —Ñ—Ä–∞–∑—ã.
        - —Å–æ–±–ª—é–¥–∞–π –∫—Ä–∞—Ç–∫–æ—Å—Ç—å
        - –ø—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–æ —Å—Ç—Ä–æ–≥–æ—Å—Ç—å. 
        3.	–§–æ—Ä–º–∞—Ç:
        - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ ‚Äî 1024 —Å–∏–º–≤–æ–ª–∞.
        - –í–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–∏—Ñ—Ä –∏ —Ñ–∞–∫—Ç–æ–≤ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞.
    """
    client = GptAPI(API_KEY)
    return client.create(prompt=prompt, user_message=post)

def main():
    try:
        request_db = RequestDataBase()
        message = redis.receive_from_queue(queue_name="text_conversion")
        if message and "content" in message and isinstance(message["content"], str):
            new_post = change_post(message["content"], message["outlinks"])
            json_news = {
                "seed": message["seed"]
            }
            request_db.create_modified_news(channel=message["channel"], id_post=message["id_post"], text=new_post)
            redis.send_to_queue(queue_name="ForModer", data=json.dumps(json_news))
    except Exception as error:
        logger.error(error)

if __name__ == '__main__':
    logger.info("Start work")
    while True:
        main()